#include <reg52.h>

void delay(unsigned int xms)
{
	int i,j;
	for(i=xms;i>0;i--)		      //i=xms即延时约xms毫秒
		for(j=112;j>0;j--);
}

void delay_us(unsigned int i)
{
	char j;
	for(i; i > 0; i--)
		for(j = 200; j > 0; j--);
}


sbit sDCMotor=P1^7;
sbit sDCOpt=P1^0;
int DCDelayTime=3;
void DCMotor(int stepNum)//x轴电机
{
	int i,j;
	for(i=0;i<stepNum;i++)
	{
		/*for(j=0;j<3;j++)
		{
			sDCMotor=0;
			delay(1);
			while(sDCOpt==1);
			sDCMotor=1;
		}*/
		
		sDCMotor=0;
		delay(DCDelayTime);
		sDCMotor=1;
		delay(DCDelayTime);
	}
}

sbit sStepMotor1=P2^0; //A+引脚
sbit sStepMotor2=P2^2; //A-引脚
sbit sStepMotor3=P2^1; //B+引脚
sbit sStepMotor4=P2^3; //B-引脚
int stepDelayTime=3;
void stepMotor(int direction,int stepNum)
{
	int i;
	for(i=0;i<stepNum;i++)
	{
		if(direction==0)
		{
			sStepMotor1 = 0; //B-状态
			sStepMotor2 = 1;
			sStepMotor3 = 0;
			sStepMotor4 = 1;
			delay(stepDelayTime); //延时
 
	    sStepMotor1 = 1; //B+状态
			sStepMotor2 = 0;
			sStepMotor3 = 0;
			sStepMotor4 = 1;
			delay(stepDelayTime); //延时
 
			sStepMotor1 = 1; //A-状态
			sStepMotor2 = 0;
			sStepMotor3 = 1;
			sStepMotor4 = 0;
			delay(stepDelayTime); //延时
 
		  sStepMotor1 = 0; //A+状态
			sStepMotor2 = 1;
			sStepMotor3 = 1;
			sStepMotor4 = 0;
			delay(stepDelayTime); //延时
			
			sStepMotor1 = 0;
			sStepMotor2 = 0;
			sStepMotor3 = 0;
			sStepMotor4 = 0;
			delay(stepDelayTime); //延时
		}
		
		if(direction==1)
		{
			sStepMotor1 = 0; //A+状态
			sStepMotor2 = 1;
			sStepMotor3 = 1;
			sStepMotor4 = 0;
			delay(stepDelayTime); //延时
 
			sStepMotor1 = 1; //A-状态
			sStepMotor2 = 0;
			sStepMotor3 = 1;
			sStepMotor4 = 0;
			delay(stepDelayTime); //延时
 
			sStepMotor1 = 1; //B+状态
			sStepMotor2 = 0;
			sStepMotor3 = 0;
			sStepMotor4 = 1;
			delay(stepDelayTime); //延时
 
			sStepMotor1 = 0; //B-状态
			sStepMotor2 = 1;
			sStepMotor3 = 0;
			sStepMotor4 = 1;
			delay(stepDelayTime); //延时
			
			sStepMotor1 = 0;
			sStepMotor2 = 0;
			sStepMotor3 = 0;
			sStepMotor4 = 0;
			delay(stepDelayTime); //延时
		}
  }
}

sbit printerStitch1=P1^6;
#define printerPins P0
int stitchDelayTime=3;
void printerStitch(unsigned char str)
{
	printerPins=str;
	delay(stitchDelayTime);
	printerPins=0x00;
	delay(stitchDelayTime);
}

sbit lineOpt=P1^1;
int iChrPla=0;
int forwardStep=20;
void retLine()
{
	while(lineOpt==0)//打印头
	{
		DCMotor(1);
	}
	DCMotor(forwardStep);//前进
	iChrPla=0;
}

int forwardLine=3;
void newLine()
{
	stepMotor(1,forwardLine);//换行
}

unsigned char code fonts[470]={
0x00,0x00,0xBE,0x00,0x00,0x00,0x06,0x00,0x06,0x00,0x28,0x7C,0x28,0x7C,0x28,0x22,
0x2C,0xF8,0x2C,0x22,0xCC,0x2C,0x10,0x68,0x66,0x64,0x9A,0x92,0x6C,0x40,0x00,0xB0,
0x70,0x00,0x00,0x38,0x44,0x82,0x00,0x00,0x00,0x00,0x82,0x44,0x38,0x22,0x14,0x3E,
0x14,0x22,0x00,0x08,0x1C,0x08,0x00,0x00,0xB0,0x70,0x00,0x00,0x00,0x08,0x08,0x08,
0x00,0x00,0x60,0x60,0x00,0x00,0x20,0x10,0x08,0x04,0x02,0x7C,0x82,0x82,0x82,0x7C,
0x00,0x84,0xFE,0x80,0x00,0xC4,0xA2,0x92,0x8A,0x86,0x92,0x92,0x92,0x92,0x7C,0x1E,
0x10,0x10,0x10,0xFE,0x5E,0x92,0x92,0x92,0x62,0x7C,0x92,0x92,0x92,0x60,0x02,0x02,
0x02,0x02,0xFE,0x7C,0x92,0x92,0x92,0x7C,0x0C,0x92,0x92,0x92,0x7C,0x00,0x00,0x24,
0x00,0x00,0x00,0x80,0x64,0x00,0x00,0x00,0x20,0x50,0x88,0x00,0x00,0x28,0x28,0x28,
0x00,0x00,0x88,0x50,0x20,0x00,0x00,0x04,0x54,0x08,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFC,0x12,0x11,0x12,0xFC,0xFF,0x89,0x89,0x89,0x7E,0x7E,0x81,0x81,0x81,0x81,0xFF,
0x81,0x81,0x81,0x7E,0xFF,0x89,0x89,0x89,0x89,0xFF,0x09,0x09,0x09,0x09,0x7E,0x81,
0x81,0x91,0xF1,0xFF,0x08,0x08,0x08,0xFF,0x81,0x81,0xFF,0x81,0x81,0x41,0x81,0xFF,
0x01,0x01,0xFF,0x18,0x24,0x42,0x81,0xFF,0x80,0x80,0x80,0x80,0xFF,0x02,0x1C,0x02,
0xFF,0xFF,0x04,0x18,0x20,0xFF,0x7E,0x81,0x81,0x81,0x7E,0xFF,0x09,0x09,0x09,0x06,
0x3E,0x41,0x61,0x7E,0x80,0xFF,0x19,0x29,0x49,0x86,0x06,0x89,0x89,0x89,0x70,0x01,
0x01,0xFF,0x01,0x01,0x7F,0x80,0x80,0x80,0x7F,0x3F,0x40,0x80,0x40,0x3F,0x7F,0x80,
0x78,0x80,0x7F,0xE3,0x14,0x08,0x14,0xE3,0x07,0x08,0xF0,0x08,0x07,0xC1,0xA1,0x99,
0x85,0x83,0x00,0xFC,0x84,0x84,0x00,0x80,0x40,0x20,0x10,0x08,0x00,0x84,0x84,0xFC,
0x00,0x00,0x08,0x04,0x08,0x00,0x00,0x10,0x10,0x10,0x00,0x00,0x00,0x18,0x1C,0x02,
0x48,0xA4,0xA4,0xA4,0xF8,0xFC,0x90,0x90,0x90,0x60,0x70,0x88,0x88,0x88,0x88,0x60,
0x90,0x90,0x90,0xFC,0x70,0xA8,0xA8,0xA8,0xB0,0xF8,0x24,0x24,0x24,0x08,0x18,0xA4,
0xA4,0xA4,0x78,0xFC,0x20,0x10,0x10,0xE0,0x00,0x00,0xF4,0x00,0x00,0x00,0x40,0x80,
0xF4,0x00,0xFC,0x20,0x50,0x80,0x00,0x00,0x00,0xFC,0x00,0x00,0xF8,0x08,0x30,0x08,
0xF8,0xF8,0x08,0x08,0x08,0xF0,0x70,0x88,0x88,0x88,0x70,0xFC,0x24,0x24,0x24,0x18,
0x18,0x24,0x24,0x24,0xFC,0x00,0xF8,0x10,0x08,0x00,0x10,0xA8,0xA8,0xA8,0x40,0x08,
0x08,0xFC,0x88,0x48,0x7C,0x80,0x80,0x80,0x7C,0x3C,0x40,0x80,0x40,0x3C,0xFC,0x80,
0x60,0x80,0xFC,0x88,0x50,0x20,0x50,0x88,0x18,0xA0,0xA0,0xA0,0xF8,0xC8,0xC8,0xA8,
0x98,0x98,0x10,0x6C,0x82,0x44,0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0x44,0x82,0x6C,
0x10,0x10,0x08,0x10,0x08,0x00,
};//94word
void printChar(unsigned char chr)
{
	int i;
	if(chr==0x20)//' '
	{
		DCMotor(6);
	}
	else if(chr==0x0d)//'\r'
	{
		retLine();
	}
	else if(chr==0x0a)//'\n'
	{
		newLine();
	}
	else
	{
		for(i=0;i<5;i++)
		{
			printerStitch(fonts[(chr-0x21)*5+i]);
			DCMotor(1);
		}
		DCMotor(1);
	}
}

int maxCharPerLine=28;
void printStr(char *str)
{
	int i = 0;
	while(str[i]!=0)
	{
		if(iChrPla%maxCharPerLine==0&&iChrPla!=0)
		{
			retLine();
			newLine();
		}
		printChar(str[i]);
		i++;
		iChrPla++;
	}
}

void main()
{
	printerStitch1=0;
	printerPins=0x00;
	
	printStr("\r\nTest---------\r\nABCDEFGHIJKLMNOPQRSTUVWXYZ abcdefghijklmnopqrstuvwxyz 1234567890 !@#$%^&*()_+-=[]\\{}|;':\",./<>?~ \r\n-------------------\r\n351workshop.top:8086\r\n");// 
	while(1);
}